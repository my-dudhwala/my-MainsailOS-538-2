#!/bin/bash
set -xe
export LC_ALL=C

# Load shared functions/configs
source /common.sh
install_cleanup_trap
source /files/00-config

echo "=== Setting up KlipperScreen ==="

# Ensure pi user exists
id pi || useradd -m -s /bin/bash pi

# Create bin folder
sudo -u pi mkdir -p /home/pi/.local/bin

# Create Python venv for KlipperScreen
sudo -u pi python3 -m venv /home/pi/.klipperscreen-venv
sudo -u pi /home/pi/.klipperscreen-venv/bin/pip install --upgrade pip wheel setuptools

# Install KlipperScreen inside venv
sudo -u pi /home/pi/.klipperscreen-venv/bin/pip install git+https://github.com/KlipperScreen/KlipperScreen.git

# Create wrapper script
cat >/home/pi/.local/bin/KlipperScreen-start.sh <<'EOF'
#!/bin/bash
source /home/pi/.klipperscreen-venv/bin/activate
exec python -m KlipperScreen
EOF
chmod +x /home/pi/.local/bin/KlipperScreen-start.sh
chown pi:pi /home/pi/.local/bin/KlipperScreen-start.sh

# Install systemd service
cat >/etc/systemd/system/KlipperScreen.service <<'EOF'
[Unit]
Description=KlipperScreen
After=systemd-user-sessions.service plymouth-quit-wait.service

[Service]
User=pi
WorkingDirectory=/home/pi
ExecStart=/home/pi/.local/bin/KlipperScreen-start.sh
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# Enable the service
systemctl enable KlipperScreen.service

echo "=== KlipperScreen setup complete, will auto-start after reboot ==="
