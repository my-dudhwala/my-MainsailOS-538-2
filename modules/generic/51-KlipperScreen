#!/bin/bash
set -xe
export LC_ALL=C

########################################
# Functions and Basic Configuration    #
########################################

source /common.sh
install_cleanup_trap
source /files/00-config

########################################
# System Packages                      #
########################################

echo "Updating system packages..."
sudo apt-get update
sudo apt-get upgrade -y

# Install dependencies for KlipperScreen
echo "Installing required packages..."
sudo apt-get install -y \
    python3-venv python3-dev python3-pip \
    libopenjp2-7 libtiff5 \
    libatlas-base-dev libgfortran5 \
    xserver-xorg x11-xserver-utils xinit \
    matchbox-window-manager \
    git

########################################
# Create user env + Python venv        #
########################################

echo "Setting up Python virtual environment for KlipperScreen..."
sudo -u pi python3 -m venv /home/pi/klipperscreen-env
sudo -u pi /home/pi/klipperscreen-env/bin/pip install --upgrade pip wheel setuptools

########################################
# Clone and install KlipperScreen      #
########################################

if [ ! -d /home/pi/KlipperScreen ]; then
    sudo -u pi git clone https://github.com/jordanruthe/KlipperScreen.git /home/pi/KlipperScreen
fi

sudo -u pi /home/pi/klipperscreen-env/bin/pip install -r /home/pi/KlipperScreen/scripts/ks_includes/requirements.txt

########################################
# X11 Autostart for pi user            #
########################################

echo "Configuring X11 autostart with KlipperScreen..."

mkdir -p /home/pi/.xsession.d
cat >/home/pi/.xsession <<'EOF'
#!/bin/bash
# Start matchbox WM and KlipperScreen
matchbox-window-manager -use_titlebar no -use_cursor no &
/home/pi/klipperscreen-env/bin/python3 /home/pi/KlipperScreen/screen.py
EOF
chmod +x /home/pi/.xsession
chown pi:pi /home/pi/.xsession

########################################
# Systemd Service                      #
########################################

echo "Installing systemd service for graphical KlipperScreen..."

cat >/etc/systemd/system/klipperscreen.service <<'EOF'
[Unit]
Description=Start X11 with KlipperScreen
After=systemd-user-sessions.service

[Service]
User=pi
Environment=DISPLAY=:0
ExecStart=/usr/bin/startx /home/pi/.xsession --
Restart=always

[Install]
WantedBy=graphical.target
EOF

sudo systemctl enable klipperscreen.service

########################################
# Finish                               #
########################################

echo "KlipperScreen setup complete. Rebooting..."
sudo reboot
