#!/bin/bash
set -xe
export LC_ALL=C

# Load shared functions/configs
source /common.sh
install_cleanup_trap
source /files/00-config

echo "=== Setting up KlipperScreen ==="

# Ensure pi user exists
id pi || useradd -m -s /bin/bash pi

# Create bin folder
sudo -u pi mkdir -p /home/pi/.local/bin

# Create Python venv for KlipperScreen
sudo -u pi python3 -m venv /home/pi/.klipperscreen-venv
sudo -u pi /home/pi/.klipperscreen-venv/bin/pip install --upgrade pip wheel setuptools

# Clone KlipperScreen repo
if [ ! -d /home/pi/KlipperScreen ]; then
    sudo -u pi git clone https://github.com/KlipperScreen/KlipperScreen.git /home/pi/KlipperScreen
else
    sudo -u pi git -C /home/pi/KlipperScreen pull --ff-only || true
fi

# Install dependencies into venv
REQ_FILE="/home/pi/KlipperScreen/scripts/KlipperScreen-requirements.txt"
if [ -f "$REQ_FILE" ]; then
    sudo -u pi /home/pi/.klipperscreen-venv/bin/pip install -r "$REQ_FILE"
fi

# Create wrapper script

cat >/home/pi/.local/bin/KlipperScreen-start.sh <<'EOF'
#!/bin/bash
source /home/pi/.klipperscreen-venv/bin/activate
exec python /home/pi/KlipperScreen/screen.py
EOF
chmod +x /home/pi/.local/bin/KlipperScreen-start.sh
chown pi:pi /home/pi/.local/bin/KlipperScreen-start.sh

# Install systemd service
cat >/etc/systemd/system/KlipperScreen.service <<'EOF'
[Unit]
Description=KlipperScreen
After=systemd-user-sessions.service plymouth-quit-wait.service

[Service]
User=pi
WorkingDirectory=/home/pi
ExecStart=/home/pi/.local/bin/KlipperScreen-start.sh
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# Enable the service
systemctl enable KlipperScreen.service

echo "=== KlipperScreen setup complete, will auto-start after reboot ==="
