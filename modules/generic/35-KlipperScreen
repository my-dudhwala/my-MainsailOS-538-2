#!/bin/bash
set -e

# Detect default non-root user (UID >= 1000)
DEFAULT_USER=$(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1; exit}' /etc/passwd)

# Sanity check
if [ -z "$DEFAULT_USER" ]; then
    echo "❌ Could not detect default user. Falling back to 'pi'."
    DEFAULT_USER="pi"
fi

echo "✅ Detected default user: $DEFAULT_USER"

# Install dependencies
apt-get update
apt-get install -y \
    git python3-pip python3-pyqt5 python3-pyqt5.qtsvg \
    python3-pyqt5.qtquick python3-pyqt5.qtmultimedia \
    python3-pyqt5.qtwebengine libxcb-xinerama0 xinput \
    xserver-xorg x11-xserver-utils xinit

# Clone your fork into the user's home dir
cd /home/$DEFAULT_USER
git clone https://github.com/my-dudhwala/my-KlipperScreen
chown -R $DEFAULT_USER:$DEFAULT_USER my-KlipperScreen

# Run official install script as detected user
sudo -u $DEFAULT_USER BACKEND="X" NETWORK="Y" bash my-KlipperScreen/scripts/KlipperScreen-install.sh

# Enable the service
systemctl enable KlipperScreen.service
